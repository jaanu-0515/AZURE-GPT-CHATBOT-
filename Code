import streamlit as st
from openai import AzureOpenAI

# --- Azure OpenAI Configuration ---
AZURE_OPENAI_ENDPOINT = "https://kgsow-mgwfjt4s-swedencentral.cognitiveservices.azure.com/"
AZURE_OPENAI_API_KEY = "YOUR_API_KEY"  # Replace securely
AZURE_OPENAI_DEPLOYMENT = "gpt-4.1-2"
AZURE_OPENAI_API_VERSION = "2024-12-01-preview"

# --- Initialize Azure Client ---
client = AzureOpenAI(
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
    api_key=AZURE_OPENAI_API_KEY,
    api_version=AZURE_OPENAI_API_VERSION,
)

# --- Streamlit Page Config ---
st.set_page_config(page_title="ü§ñ Azure GPT Chatbot", page_icon="ü§ñ", layout="wide")

# --- Custom CSS Styling ---
st.markdown("""
<style>
/* --- Background Gradient --- */
.stApp {
    background: linear-gradient(160deg, #e0f2fe, #ede9fe, #faf5ff);
    background-size: cover;
}

/* --- Title & Subtitle --- */
.title {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(90deg, #2563eb, #7c3aed, #db2777);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: left;
    margin-bottom: 0.4rem;
}
.subtitle {
    font-size: 1.1rem;
    color: #334155;
    margin-bottom: 30px;
    text-align: left;
}

/* --- Chat Messages --- */
[data-testid="stChatMessage"] {
    border-radius: 18px;
    padding: 12px 18px;
    margin: 10px 0;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    animation: fadeIn 0.3s ease-in;
}
[data-testid="stChatMessage"][class*="user"] {
    background-color: #dbeafe;
    color: #111827;
    text-align: right;
}
[data-testid="stChatMessage"][class*="assistant"] {
    background-color: #f1f5f9;
    border-left: 4px solid #6366f1;
    color: #1e293b;
}

/* --- Chat Input --- */
[data-testid="stChatInput"] textarea {
    border-radius: 25px !important;
    border: 2px solid #7c3aed;
    background-color: #ffffff;
    padding: 10px;
    font-size: 1rem;
    color: #111827;
}

/* --- Sidebar --- */
.sidebar-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 1rem;
}
.sidebar-item {
    margin: 8px 0;
    padding: 10px;
    border-radius: 10px;
    background: #e0e7ff;
    cursor: pointer;
    transition: 0.25s;
    color: #1e293b;
}
.sidebar-item:hover {
    background: #c7d2fe;
    transform: scale(1.03);
}
hr {
    border: 1px solid #e2e8f0;
}

/* --- Animation --- */
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(8px);}
    to {opacity: 1; transform: translateY(0);}
}
</style>
""", unsafe_allow_html=True)

# --- Sidebar ---
st.sidebar.image("https://cdn-icons-png.flaticon.com/512/4712/4712103.png", width=110)
st.sidebar.markdown("<div class='sidebar-title'>üß≠ Chat Controls</div>", unsafe_allow_html=True)

# Handle New Chat Button
if st.sidebar.button("üÜï New Chat"):
    st.session_state.clear()
    st.session_state.messages = [{"role": "system", "content": "You are a helpful assistant."}]
    st.rerun()

st.sidebar.markdown("<hr>", unsafe_allow_html=True)
st.sidebar.caption("üí¨ Built with Streamlit + Azure OpenAI")

# --- Main Chat Interface ---
st.markdown("<h1 class='title'>ü§ñ Azure GPT Chatbot</h1>", unsafe_allow_html=True)
st.markdown("<p class='subtitle'>Your intelligent assistant powered by Azure GPT-4.1 üåê</p>", unsafe_allow_html=True)

# Initialize Chat History
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": "You are a helpful assistant."}]

# Display Previous Messages
for msg in st.session_state.messages[1:]:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# Chat Input
user_input = st.chat_input("Type your message here...")

if user_input:
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.markdown(user_input)

    with st.spinner("Thinking... üí≠"):
        try:
            response = client.chat.completions.create(
                model=AZURE_OPENAI_DEPLOYMENT,
                messages=st.session_state.messages,
                max_completion_tokens=500,
                temperature=0.7,
            )
            reply = response.choices[0].message.content
            st.session_state.messages.append({"role": "assistant", "content": reply})
            with st.chat_message("assistant"):
                st.markdown(reply)
        except Exception as e:
            st.error(f"‚ö† Something went wrong: {e}")
